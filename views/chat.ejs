<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chit-Chat | Room <%= roomId %></title>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white flex flex-col h-screen">

<!-- NAVBAR -->
<header class="bg-gray-800 p-4 flex justify-between items-center">
    <img src="/img/Chit-ChatBlue.png" alt="Chit-Chat Logo" width="40" height="40" class="inline-block align-middle mr-2">
    <h2 class="text-indigo-400 font-bold text-lg">
        Chit-Chat <span class="text-gray-400 text-sm">| Room ID:</span>
        <span class="text-white font-mono"><%= roomId %></span>
    </h2>
    <span class="text-sm text-gray-300">Logged in as <b><%= username %></b></span>
</header>

<div class="flex flex-1 overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-gray-800 p-4 overflow-y-auto">

        <% if (username === admin) { %>
        <div id="admin-controls" class="mb-4">
            <h3 class="text-indigo-400 uppercase text-sm mb-2">Join Requests</h3>
            <div id="request-list" class="space-y-2"></div>
        </div>
        <% } %>

        <h3 class="text-indigo-400 uppercase text-sm mb-2">Participants</h3>
        <ul id="participants-list" class="space-y-1"></ul>

        <button id="leave-room-btn" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded">
        Leave Room
        </button>

    </aside>

    <!-- CHAT AREA -->
    <main class="flex-1 flex flex-col">
        <div id="messages" class="flex-1 p-4 overflow-y-auto space-y-2"></div>

        <div class="flex p-4 gap-2 bg-gray-800">
            <textarea id="msg-input"
                    rows="2"
                   class="flex-1 p-2 rounded bg-gray-700 text-white"
                   placeholder="Type message..." ></textarea>
            <button id="send-btn" class="bg-indigo-600 px-4 rounded">Send</button>
        </div>
    </main>
</div>

<script>
const socket = io();

const roomId = "<%= roomId %>";
const username = "<%= username %>";
const isAdmin = "<%= admin %>" === username;

// Join room ONCE
socket.emit("join_room", { roomId });

// ---------------- PARTICIPANTS ----------------
socket.on("participants_update", data => {
    const { users, admin } = data;
    const list = document.getElementById("participants-list");
    list.innerHTML = "";
    users.forEach(u => {
        const li = document.createElement("li");
        li.textContent = u + (u === admin ? " (Admin)" : "");
        list.appendChild(li);
    });
});

// ---------------- MESSAGES ----------------
const messagesDiv = document.getElementById("messages");

socket.on("chat_history", history => {
    messagesDiv.innerHTML = "";
    history.forEach(m => addMessage(m.sender, m.text));
});

socket.on("new_message", msg => {
    addMessage(msg.sender, msg.text);
});

socket.on("admin_left", () => {
    alert("The admin has left the room. The room is now closed.");
    window.location.href = "/chatroom";
});

socket.on("Leave_Success", () => {
    window.location.href = "/chatroom";
});

function addMessage(sender, text) {
    const colorMap = {
        Join: "green",
        Leave: "red"
    };

    const div = document.createElement("div");

    div.style.wordBreak = "break-word";
    div.style.overflowWrap = "anywhere";
    div.style.whiteSpace = "pre-wrap";

    div.style.color = colorMap[sender] || "white";
    if(sender === "Join" || sender === "Leave") {
        div.style.fontStyle = "italic";
        div.innerHTML = text;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return;
    }
    div.innerHTML = `<strong>${sender}:</strong> ${text}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}


// Send message
const msgInput = document.getElementById("msg-input");

// Enter key or Enter + Shift for new line
msgInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();  
        sendMessage();        
    }
});

function sendMessage() {
    const rawText = msgInput.value;

    const text = rawText.replace(/\n+$/, "");

    if (!text.trim()) return;

    socket.emit("send_message", { roomId, text });
    msgInput.value = "";
}



document.getElementById("send-btn").onclick = sendMessage;

// ---------------- ADMIN JOIN REQUESTS ----------------
if (isAdmin) {
    socket.on("join_request", ({username, socketId}) => {
        const div = document.createElement("div");
        div.id = `req-${username}`;
        div.innerHTML = `
            <strong>${username}</strong><br/>
            <button onclick="approve('${username}')">Accept</button>
            <button onclick="deny('${username}')">Deny</button>
        `;
        document.getElementById("request-list").appendChild(div);
    });
}

function approve(username) {
    socket.emit("admin_decision", { roomId, targetUsername: username, action: "accept" });
    document.getElementById(`req-${username}`).remove();
}

function deny(username) {
    socket.emit("admin_decision", { roomId, targetUsername: username, action: "deny" });
    document.getElementById(`req-${username}`).remove();
}

document.getElementById("leave-room-btn").onclick = () => {
    socket.emit("leave_room", { roomId });
};


</script>

</body>
</html>
